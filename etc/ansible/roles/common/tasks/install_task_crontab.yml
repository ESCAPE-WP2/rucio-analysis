- name: load crontab
  block:
    - name: load cronjobs from yml
      include_vars:
        file: "roles/{{ ansible_role }}/vars/crontab.yml"
        name: cronjobs
      delegate_to: 127.0.0.1
    - name: add tasks to crontab
      cron:
        name: "{{ item.name }}"
        minute: "{{ item.minute }}"
        hour: "{{ item.hour }}"
        day: "{{ item.day }}"
        month: "{{ item.month }}"
        weekday: "{{ item.weekday }}"
        disabled: "{{ item.disabled | default(\"no\") }}"
        job: docker run --rm
          -e RUCIO_CFG_RUCIO_HOST="{{ RUCIO_CFG_RUCIO_HOST }}"
          -e RUCIO_CFG_AUTH_HOST="{{ RUCIO_CFG_AUTH_HOST }}"
          -e RUCIO_CFG_ACCOUNT="{{ RUCIO_CFG_ACCOUNT }}"
          -e RUCIO_CFG_AUTH_TYPE="{{ RUCIO_CFG_AUTH_TYPE }}"
          {% if RUCIO_CFG_AUTH_TYPE == 'userpass' %}
            -e RUCIO_CFG_USERNAME={{ RUCIO_CFG_USERNAME }} 
            -e RUCIO_CFG_PASSWORD={{ RUCIO_CFG_PASSWORD }} 
          {% endif %}
          {% if not RUCIO_CFG_AUTH_TYPE == 'oidc' %}
            -e RUCIO_CFG_CLIENT_CERT="/opt/rucio/etc/client.crt" 
            -e RUCIO_CFG_CLIENT_KEY="/opt/rucio/etc/client.key" 
            -v {{ ansible_env.HOME }}/.x509/{{ RUCIO_CFG_CLIENT_CERT | basename }}:/opt/rucio/etc/client.crt 
            -v {{ ansible_env.HOME }}/.x509/{{ RUCIO_CFG_CLIENT_KEY | basename }}:/opt/rucio/etc/client.key 
          {% endif %}
          {% if mount_k8s_cluster_config|bool %} 
            -v {{ KUBERNETES_CONFIG_PATH }}:/etc/cluster-config.yml 
          {% endif %} 
          {% if mount_rucio_oidc_admin_token|bool %} 
            {% if RUCIO_CFG_ACCOUNT == 'root' %}
              -v /tmp/auth_token_for_account_root:/tmp/root/.rucio_root/auth_token_for_account_root
            {% else %}
              -v /tmp/auth_token_for_account_{{ RUCIO_CFG_ACCOUNT }}:/tmp/user/.rucio_user/auth_token_for_account_{{ RUCIO_CFG_ACCOUNT }}
            {% endif %}
          {% endif %} 
          -e TASK_FILE_PATH="/opt/rucio-analysis/etc/tasks/{{ item.task_subpath }}"
          -e PYTHONWARNINGS='ignore:Unverified HTTPS request'
          -e RUCIO_VOMS="{{ RUCIO_VOMS }}" 
          --name rucio-analysis-{{ item.name }} 
          rucio-analysis:{{ RUCIO_ANALYSIS_IMAGE_MAKE_TARGET }} >> {{ item.override_log_path | default("/var/log/cron/rucio-analysis/" + item.name | replace('-','_') + "_`date +\%Y\%m\%d`.log 2>&1") }}
      loop: "{{ cronjobs.jobs }}"
