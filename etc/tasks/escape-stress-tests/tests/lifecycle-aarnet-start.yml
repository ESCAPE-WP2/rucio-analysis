# A test to emulate the SDP-SRC interface.
# This workflow consists of:
# - Creation of empty dataset with metadata at non-deterministic RSE 1
# - Creation of metadata-based subscription to replicate to RSE 2
# - Upload via GFAL to non-deterministic RSE 1
# - Registration within Rucio
# Data should then be replicated at RSE 2.
prepare-sdp-src:
  description: "Create dataset and set metadata in prep for SDP-SRC test."
  module_name: "tasks.tests.subscriptions"
  class_name: "TestCreateSubscription"
  enabled: true
  args:
  kwargs:
    scope: testing_subscription
    dataset_name: test_lifecycle_aarnet_dataset_1
    fixed_metadata: # Explicit k-v pairs to set as metadata
      project: test_subscription_aarnet_skao_proj_1
    subscription_name: test_lifecycle_aarnet_subscription_1
    filter:
      scope:
        - testing_subscription
      project:
        - test_subscription_aarnet_skao_proj_1
    replication_rules:
      - copies: 1
        rse_expression: QOS=FAST 
        lifetime: 15552000 # 30 days x 6 = 6 months
        activity: User Subscriptions
    comments: Test subscription
    subscription_lifetime: 3 # days
    retroactive: false
    dry_run: false
    priority: 3

test-upload-nondeterministic:
  description: "Test uploading to non-deterministic RSEs."
  module_name: "tasks.tests.upload_nondeterministic"
  class_name: "TestUploadNondeterministic"
  enabled: true
  args:
  kwargs:
    rse: AARNET_PER_ND 
    lfnpfn_spoofer_class_name: LFNPFNSpoofer_SKAO_Testing_v1
    lfnpfn_spoofer_kwargs:
      n_datasets_per_project: 10
      n_files_per_dataset: 10
      n_projects: 1
      size: 10000000 # 10 Mbytes
      test_dir_prefix: nondeterministic_test
    scheme: https
    hostname: aarnet-escape.cdndev.aarnet.edu.au 
    prefix: /eos/escape/testbed/EPER/rucio-ska/dev/nondeterministic 
    scope: testing_subscription
    filelist_dir: ingest

register-nondeterministic:
  description: "Test registering to non-deterministic RSEs."
  module_name: "tasks.tests.register_nondeterministic"
  class_name: "TestRegisterNondeterministic"
  enabled: true
  args:
  kwargs:
    rse: AARNET_PER_ND
    scheme: https
    hostname: aarnet-escape.cdndev.aarnet.edu.au
    prefix: /eos/escape/testbed/EPER/rucio-ska/dev/nondeterministic 
    filelist_dir: ingest
    lifetime: 3600 # seconds
    dataset_name: test_lifecycle_aarnet_dataset_1 
